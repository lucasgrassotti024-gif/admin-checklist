<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dashboard - Checklists</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --primary:#0078ff;
  --accent:#00b4ff;
  --bg:#ffffff;
  --white:#ffffff;
  --text:#1a1a1a;
  --muted:#666;
  --card:#ffffff;
  --border:#e3e6eb;
  --shadow:0 8px 28px rgba(0,0,0,0.08);
}
.dark {
  --bg:#0b1120;
  --white:#111827;
  --card:#111827;
  --text:#e9eef5;
  --muted:#a7b0bc;
  --border:#1f2937;
  --shadow:0 4px 16px rgba(0,0,0,0.6);
}
*{box-sizing:border-box;font-family:"Inter",sans-serif;transition:background-color .25s ease,color .25s ease,border-color .25s ease;}
body{margin:0;background:var(--bg);color:var(--text);display:flex;flex-direction:column;min-height:100vh;}

header{
  backdrop-filter:blur(14px);
  background:var(--white);
  display:flex;justify-content:space-between;align-items:center;
  padding:14px 26px;position:sticky;top:0;z-index:10;
  border-bottom:1px solid var(--border);
  box-shadow:var(--shadow);
}
.dark header{
  background:var(--card);
}
h1{font-family:"Outfit";font-weight:800;font-size:1.2rem;color:var(--primary);margin:0;}
.dark h1{color:#66b2ff;}

#themeToggle{
  cursor:pointer;background:var(--card);border:1px solid var(--border);
  border-radius:50%;width:36px;height:36px;font-size:1.2rem;
  display:flex;align-items:center;justify-content:center;
}
.dark #themeToggle{background:var(--white);color:var(--primary);}
#datetime{font-size:.85rem;color:var(--muted);margin-left:12px;}

nav a{
  text-decoration:none;font-weight:600;margin-left:18px;color:var(--primary);
  position:relative;
}
nav a::after{
  content:"";position:absolute;bottom:-3px;left:0;width:0;height:2px;background:var(--primary);transition:.25s;
}
nav a:hover::after{width:100%;}

.wrap{max-width:1100px;margin:auto;padding:24px;flex:1;}
.grid{display:grid;gap:20px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));}
.card{
  background:var(--white);
  border-radius:14px;
  box-shadow:var(--shadow);
  border:1px solid var(--border);
  padding:20px;
  text-align:center;
}
.dark .card{background:var(--card);}

.total-card {
  text-align:center;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  color:#fff;
  border-radius:16px;
  padding:24px;
  box-shadow:0 6px 20px rgba(0,120,255,0.4);
  font-family:"Outfit";
  font-weight:700;
  margin-bottom:24px;
}
.total-card span {
  display:block;
  font-size:2.5rem;
  font-weight:800;
  margin-top:10px;
}

footer{
  text-align:center;
  padding:14px;
  color:var(--muted);
  font-size:.85rem;
  background:var(--white);
  border-top:1px solid var(--border);
  box-shadow:0 -2px 8px rgba(0,0,0,0.05);
}
.dark footer{background:var(--card);}

/* RESPONSIVO */
@media (max-width: 800px){
  .wrap{padding:20px 18px;}
  header{padding:12px 18px;}
}
@media (max-width: 600px){
  header{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
  header > div{
    display:flex;
    align-items:center;
    justify-content:space-between;
    width:100%;
    flex-wrap:wrap;
    row-gap:6px;
  }
  #datetime{margin-left:0;font-size:.8rem;}
  nav a{margin-left:12px;font-size:.95rem;}
}
@media (max-width: 480px){
  header{padding:10px 12px;}
  h1{font-size:1.05rem;}
  #themeToggle{width:34px;height:34px;font-size:1rem;}
  .wrap{padding:18px 12px;}
}
</style>
</head>
<body>

<header>
  <h1>Dashboard</h1>
  <div style="display:flex;align-items:center;gap:14px;flex-wrap:wrap;">
    <span id="datetime"></span>
    <button id="themeToggle">ðŸŒ™</button>

    <nav id="mainNav">
      <a id="adminLink" href="admin.html">Administrador</a>
      <a href="excluidos.html">ExcluÃ­dos</a>
    </nav>
  </div>
</header>

<div class="wrap">
  <div class="total-card">
    Total de Checklists
    <span id="totalChecklists">0</span>
  </div>

  <div class="grid">
    <div class="card"><canvas id="chart1"></canvas></div>
    <div class="card"><canvas id="chart2"></canvas></div>
    <div class="card"><canvas id="chart3"></canvas></div>
  </div>
</div>

<footer>
  Â© 2025 | Sistema de Checklists â€” Desenvolvido por <b>Lucas Grassotti Spolavori</b>
</footer>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCxI5gx0LS0ny2y6UnPUCyW0zf1BjnTSco",
  authDomain: "checklist-rss3.firebaseapp.com",
  projectId: "checklist-rss3",
  storageBucket: "checklist-rss3.appspot.com",
  messagingSenderId: "179261205524",
  appId: "1:179261205524:web:376152c3b94fb115f14b01",
  measurementId: "G-47CPMQ3ZTC"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script>
/* DATA E TEMA */
setInterval(()=>{
  document.getElementById("datetime").textContent = new Date().toLocaleString("pt-BR",{timeZone:"America/Sao_Paulo"});
},1000);

const toggle=document.getElementById("themeToggle");
if(localStorage.getItem("tema")==="dark"){document.body.classList.add("dark");toggle.textContent="â˜€ï¸";}
toggle.onclick=()=>{
  document.body.classList.toggle("dark");
  const dark=document.body.classList.contains("dark");
  toggle.textContent=dark?"â˜€ï¸":"ðŸŒ™";
  localStorage.setItem("tema",dark?"dark":"light");
};

/* EVITAR RELOGIN AO VOLTAR */
document.getElementById('adminLink').addEventListener('click', function(e){
  e.preventDefault();
  localStorage.setItem('auth','true');
  window.location.href = 'admin.html';
});

/* === BUSCAR CHECKLISTS DO FIRESTORE === */
async function getChecklists(){
  try{
    const snap = await db.collection('checklists').get();
    return snap.docs.map(doc=>doc.data());
  }catch(err){
    console.error('Erro ao carregar checklists no dashboard:', err);
    return [];
  }
}

(async function initDashboard(){
  const checklists = await getChecklists();

  /* TOTAL */
  document.getElementById("totalChecklists").textContent = checklists.length;

  /* GRÃFICO 1 - Checklists por mÃªs */
  const meses=["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
  const counts = new Array(12).fill(0);
  checklists.forEach(c=>{
    let mes = NaN;
    if(c.data){
      const d = new Date(c.data);
      if(!isNaN(d)) mes = d.getMonth();
    }
    if(isNaN(mes) && c.criadoEm){
      const d2 = new Date(c.criadoEm);
      if(!isNaN(d2)) mes = d2.getMonth();
    }
    if(!isNaN(mes)) counts[mes]++;
  });
  new Chart(document.getElementById("chart1"),{
    type:"bar",
    data:{labels:meses,datasets:[{label:"Checklists",data:counts,backgroundColor:"rgba(0,120,255,0.7)"}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });

  /* GRÃFICO 2 - VeÃ­culos por tipo */
  const tipos = {carro:0, caminhÃ£o:0, trator:0};
  checklists.forEach(c=>{
    const t = (c.tipo||"").toLowerCase();
    if(t.includes("carro")) tipos.carro++;
    else if(t.includes("caminh")) tipos.caminhÃ£o++;
    else if(t.includes("trator")) tipos.trator++;
  });
  new Chart(document.getElementById("chart2"),{
    type:"doughnut",
    data:{
      labels:["Carros","CaminhÃµes","Tratores"],
      datasets:[{
        data:[tipos.carro, tipos.caminhÃ£o, tipos.trator],
        backgroundColor:[
          "rgba(0,120,255,0.85)",
          "rgba(0,180,255,0.75)",
          "rgba(0,100,200,0.8)"
        ],
        borderWidth:1,
        hoverOffset:10
      }]
    },
    options:{plugins:{legend:{position:"bottom"}}}
  });

  /* GRÃFICO 3 - Checklists Ãºltimos 7 dias */
  const dias = [];
  const hoje = new Date();
  for(let i=6;i>=0;i--){
    const d = new Date(hoje);
    d.setDate(hoje.getDate()-i);
    dias.push(d.toISOString().split("T")[0]); // yyyy-mm-dd
  }
  const contagens = dias.map(day =>
    checklists.filter(c => {
      const dataStr = (c.data||"").toString();
      const criadoStr = (c.criadoEm||"").toString();
      return dataStr.startsWith(day) || criadoStr.startsWith(day);
    }).length
  );
  new Chart(document.getElementById("chart3"),{
    type:"line",
    data:{
      labels:dias.map(d=>d.split("-").reverse().slice(0,2).join("/")),
      datasets:[{label:"Ãšltimos 7 dias",data:contagens,fill:false,borderColor:"#0078ff",tension:0.3}]
    },
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
})();
</script>
</body>
</html>
